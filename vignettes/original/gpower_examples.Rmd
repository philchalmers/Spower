---
title: "G*Power examples evaluated with Spower"
author: Phil Chalmers
date: "`r Sys.Date()`"
output: 
  bookdown::html_document2:
    base_format: rmarkdown::html_vignette
    number_sections: false
    toc: true
vignette: >
  %\VignetteIndexEntry{G*Power examples evaluated with Spower}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r nomessages, echo = FALSE}
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE
)
options(digits=4)
par(mar=c(5,4,1,1)+.1)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
library(Spower)
set.seed(42)
formals(Spower)$verbose <- FALSE
```

This vignette replicates several of the examples found in the G\*Power manual (version 3.1). It is not meant to be exhaustive but instead demonstrates how power analyses could be computed and extended using simulation methodology by either editing the default functions found within the package or by creating a new user-defined function for yet-to-be-defined statistical analysis contexts.

# Correlation

Power associated with the hypotheses $$H_0:\, \rho-\rho_0=0$$ $$H_1:\, \rho-\rho_0\ne 0$$

where $\rho$ is the population correlation and $\rho_0$ the null hypothesis constant.

### Example 3.3; Difference from constant (one sample case)

Sample size estimate to reject $H_0:\, \rho_0=.60$ in correlation analysis with $1-\beta=.95$ probability when $\rho=.65$.

```{r}
(out <- Spower(p_r, n = NA, r = .65, rho = .60,
			   power = .95, interval=c(500,3000)))
```

G\*power estimates $n$ to be 1929 using the same Fisher z-transformation approximation.

### Test against constant $\rho_0=0$

Unlike the previous section, this is the more canonical version of the hypotheses involving correlation coefficients. Power associated with $\rho = .3$ with 100 pairs of observations, tested against $\rho_0=0$.

```{r}
Spower(p_r, n = 100, r = .3)
```

Sample size estimate to reject $H_0:\, \rho_0=0$ in correlation analysis with $1-\beta=.95$ probability when $\rho=.3$.

```{r}
(out <- Spower(p_r, n = NA, r = .3,
			   power = .95, interval=c(50,1000)))
```

Compare to approximate result from `pwr` package.

```{r}
pwr::pwr.r.test(r=.3, power=.95)
```

### Example 27.3; Correlation - inequality of two independent Pearson râ€™s

```{r}
n <- 206
n2_n1 <- 51/n
Spower(p_2r, n=n, r.ab1=.75, r.ab2=.88, n2_n1=n2_n1)
```

G\*power gives power of .726.

### Example 16.3; Point-biserial correlation

```{r}
# solution per group
out <- Spower(p_t.test, r = .25, power = .95, n = NA,
			  two.tailed=FALSE, interval=c(50, 200))
out

# total sample size required
ceiling(out$n) * 2
```

G\*power gives the result $N=164$.

Relatedly, one can specify $d$, Cohen's standardized mean-difference effect size, instead of $r$ since $d$ is easily converted to $r$.

### Example 31.3; tetrachoric correlation


```{r}
F <- matrix(c(203, 186, 167, 374), 2, 2)
N <- sum(F)
(marginal.x <- colSums(F)/N)
(marginal.y <- rowSums(F)/N)

# converted to intercepts
tauX <- qnorm(marginal.x)[2]
tauY <- qnorm(marginal.y)[2]
c(tauX, tauY)
```

G\*power gives $n=463$, though uses the SE value at the null (Score test). `p_r.cat()`, on 
the other hand, defaults to the Wald approach where the SE is at the MLE. To switch, use 
`score=FALSE`, though note that this requires twice as many computations.

```{r}
Spower(p_r.cat, n=NA, r=0.2399846, tauX=tauX, tauY=tauY, score=FALSE, two.tailed=FALSE,
       power = .95, interval=c(100, 500), parallel=TRUE, check.interval=FALSE)
```


# Proportions

### Example 4.3; One sample proportion tests

One sample, one-tailed proportions test given data generated from a population tested against $\pi_0 = .65$ with $g=.15$ (hence, $\pi = .65+g=.80$) with $n=20$.

```{r}
pi <- .65
g <- .15
p <- pi + g

Spower(p_prop.test, n=20, prop=p, pi=pi, 
	   two.tailed=FALSE, interval=c(5,50))

```

G\*power gives the estimate $1-\beta=.4112$.

Fisher's exact test is also supported by using the argument `exact = TRUE`.

```{r}
# Fisher exact test
Spower(p_prop.test, n=20, prop=p, pi=pi, exact=TRUE, 
	   two.tailed=FALSE, interval=c(5,50))
```

### Example 22.1; Sign test

Normal as the parent distribution.

```{r}
Spower(p_wilcox.test, n=649, d=.1, type='one.sample',  two.tailed=FALSE)
```
G\*power gives the power estimate of .800. 

A one-sample sign test with Laplace distribution as the parent:

```{r}
library(VGAM)

parent <- function(n, d) VGAM::rlaplace(n, d)

Spower(p_wilcox.test, n=11, d=.8, parent1=parent, type='one.sample',
	   two.tailed=FALSE)
```

G\*power gives the estimate .830. 


### Example 5.3; Two dependent proportions test (McNemar's test)

```{r}
obrien2002 <- matrix(c(.54, .32, .08, .06), 2, 2,
					 dimnames = list('Treatment' = c('Yes', 'No'),
					 				'Standard' = c('Yes', 'No')))
obrien2002

Spower(p_mcnemar.test, n=50, prop=obrien2002, replications=30000,
	   two.tailed=FALSE)
```

G\*Power gives .839 ($\alpha = .032$). Slightly more power can be achieved when not using the continuity correction, though in general this is not recommended in practice.

```{r}
Spower(p_mcnemar.test, n=50, prop=obrien2002, 
	   two.tailed=FALSE, correct=FALSE)
```

# Multiple Linear Regression (Random IVs)

### Example 7.3 

```{r}
Spower(p_lm, n=95, R2=.1, k=5, fixed.X=FALSE)
```

G\*power gives 0.662, though note that G\*power claims this a one-tailed test.

# Multiple Linear Regression (Fixed IVs)

### Example 13.1

```{r}
Spower(p_lm, n=95, R2=.1, k=5)
```

G\*power gives $1-\beta = .673$.

### Example 14.3

Note that `k` is total IVs, `k.R2_0` is number of IVs for baseline model.

```{r}
Spower(p_lm, n=90, R2=.3, k=9, R2_0=.25, k.R2_0=5, sig.level=.01)
```

G\*power gives $1-\beta = .241$. Solving the sample size to achieve 80% power

```{r}
Spower(p_lm, n=NA, R2=.3, R2_0 = .25, k=9, k.R2_0=5,
	   sig.level=.01, power=.8, interval=c(100, 400))
```

G\*power gives $n = 242$.

### Example 14.3b

Compare model with 12 IVs to model with 9 IVs.

```{r}
Spower(p_lm, n=200, R2=.16, R2_0 = .1, k=12, 
	   k.R2_0=9, R2.resid=.8, sig.level=.01)
```

G\*power gives $1-\beta = .767$.

# Fixed effects ANOVA - One way (F-test) 

### Example 10.3

```{r}
Spower(p_anova.test, n=NA, k=10, f=.25, power=.95, interval=c(20, 300))
```

G\*power gives the estimate $n=39$.

Fixing $n=200$ in total (hence, $n=200/k=20$) and performing a compromise analysis assuming $q=\frac{\beta}{\alpha}=1$,

```{r}
Spower(p_anova.test, n=20, k=10, f=.25, beta_alpha=1, replications=30000)
```

G\*Power gives $\alpha=\beta=0.159$.

# Variance tests

### Example 26.3; Difference from constant (one sample case)

```{r}
# solve n for variance ratio of 1/1.5 = 2/3, one.tailed, 80% power
Spower(p_var.test, n=NA, sds=sqrt(1), sigma=sqrt(1.5), 
	   two.tailed=FALSE, power=.80, interval=c(10, 200))
```

G\*power gives sample size of 81.

## Example 15.3; Two-sample variance test

For a two-sample equality of variance test with equal sample sizes,

```{r}
# solve n for variance ratio of 1/1.5 = 2/3, two.tailed, 80% power
Spower(p_var.test, n=NA, sds=sqrt(c(1, 1.5)), 
	   two.tailed=TRUE, power=.80, interval=c(50, 300))
```

G\*Power gives estimate of 193 per group.

# t-tests

Estimate sample size ($n$) per group in independent samples $t$-test, one-tailed, medium effect size ($d=0.5$), $\alpha=0.05$, 95% power ($1-\beta = 0.95$), equal sample sizes ($\frac{n_2}{n_1}=1$).

```{r}
(out <- Spower(p_t.test, n = NA, d = .5, two.tailed=FALSE, 
			   power = .95, interval=c(10,500)))
```

```{r echo=FALSE}
so <- summary(out)
```

G\*power estimate is 88 per group, `Spower` estimate is `r out$n` with the 95% CI [`r so$predCIs_root`].


### Example 19.3; Paired samples t-test

```{r}
Spower(p_t.test, n=50, d=0.421637, type = 'paired')
```

G\*power gives power estimate of .832.

### Example 20.3; One-sample t-test

```{r}
Spower(p_t.test, n=NA, d=.625, power=.95, 
	   two.tailed=FALSE, type='one.sample', interval=c(10, 100))
```

G\*power gives sample size of $n=30$.

```{r}
Spower(p_t.test, n=NA, d=.1, power=.9, 
	   type='one.sample', sig.level=.01, interval=c(100,2000))
```

G\*power gives sample size of $n=1492$.

## Wilcox tests

### Example 22.3; One-sample test with normal distribution

```{r}
Spower(p_wilcox.test, n=649, d=.1, type='one.sample', two.tailed=FALSE)
```

G\*power provide power estimate of .800.

### Two-sample test with Laplace distributions

```{r wilcox}
library(VGAM)

parent1 <- function(n, d) VGAM::rlaplace(n, d)
parent2 <- function(n, d) VGAM::rlaplace(n)

nr <- 134/67
Spower(p_wilcox.test, n=67, n2_n1=nr,
	   d=0.375, parent1=parent1, parent2=parent2)
```

G\*power gives power of .847. 
