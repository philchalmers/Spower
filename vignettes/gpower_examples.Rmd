---
title: "G*Power examples evaluated with Spower"
author: Phil Chalmers
date: "`r Sys.Date()`"
output: 
  bookdown::html_document2:
    base_format: rmarkdown::html_vignette
    number_sections: false
    toc: true
vignette: >
  %\VignetteIndexEntry{G*Power examples evaluated with Spower}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r nomessages, echo = FALSE}
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE
)
options(digits=4)
par(mar=c(5,4,1,1)+.1)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
library(Spower)
set.seed(1234)
```

This vignette replicates several of the examples found in the G\*Power manual (version 3.1). It is not meant to be exhaustive but instead demonstrates how power analyses could be computed and extended using simulation methodology by either editing the default functions found within the package or by creating a new user-defined function for yet-to-be-defined statistical analysis contexts.

# Correlation

Power associated with the hypotheses $$H_0:\, \rho-\rho_0=0$$ $$H_1:\, \rho-\rho_0\ne 0$$

where $\rho$ is the population correlation and $\rho_0$ the null hypothesis constant.

### Difference from constant (one sample case; Example 3.3)

Sample size estimate to reject $H_0:\, \rho_0=.60$ in correlation analysis with $1-\beta=.95$ probability when $\rho=.65$.

```{r}
(out <- Spower(p_r, n = NA, r = .65, rho = .60,
			   power = .95, interval=c(1000,4000), verbose=FALSE))
```

G\*power estimates $n$ to be 1928, though `Spower` returns the much larger `r out$n`. It's unclear why this discrepancy is so large, though given that the simulation approach is based on simulating and analyzing the data with the `car::linearHypothesis()` function the `Spower` results appear more reflective of what would be expected in practice.

### Test against constant $\rho_0=0$

Power associated with $\rho = .3$ with 100 pairs of observations, tested against $\rho_0=0$.

```{r}
Spower(p_r, n = 100, r = .3, verbose=FALSE)
```

Sample size estimate to reject $H_0:\, \rho_0=0$ in correlation analysis with $1-\beta=.95$ probability when $\rho=.3$.

```{r}
(out <- Spower(p_r, n = NA, r = .3,
			   power = .95, interval=c(50,1000), verbose=FALSE))
```

Compare to approximate result from `pwr` package.

```{r}
pwr::pwr.r.test(r=.3, power=.95)
```

# Proportions

## One sample proportion tests (Example 4.3)

One sample, one-tailed proportions test given data generated from a population tested against $\pi_0 = .65$ with $g=.15$ (hence, $\pi = .65+g=.80$) with $n=20$.

```{r}
pi <- .65
g <- .15
p <- pi + g

Spower(p_prop.test, n=20, prop=p, pi=pi, 
	   two.tailed=FALSE, interval=c(5,50), verbose=FALSE)

```

G\*power gives the estimate $1-\beta=.4112$.

Fisher's exact test is also supported by using the argument `exact = TRUE`.

```{r}
# Fisher exact test
Spower(p_prop.test, n=20, prop=p, pi=pi, exact=TRUE, 
	   two.tailed=FALSE, interval=c(5,50), verbose=FALSE)
```

## Two dependent proportions test (McNemar's test; Example 5.3)

```{r}
obrien2002 <- matrix(c(.54, .32, .08, .06), 2, 2,
					 dimnames = list('Treatment' = c('Yes', 'No'),
					 				'Standard' = c('Yes', 'No')))
obrien2002

Spower(p_mcnemar.test, n=50, prop=obrien2002, replications=30000,
	   two.tailed=FALSE, verbose=FALSE)
```

G\*Power gives .839 ($\alpha = .032$). Slightly more power can be achieved when not using the continuity correction, though in general this is not recommended in practice.

```{r}
Spower(p_mcnemar.test, n=50, prop=obrien2002, 
	   two.tailed=FALSE, correct=FALSE, verbose=FALSE)
```

# Multiple Linear Regression

### Example 7.3.1

First example,

```{r eval=FALSE}
# TODO
Spower(p_lm, n=95, k=5, R2=.1, two.tailed=FALSE)
```

G\*power gives power of 0.662627.

# F test: Fixed effects ANOVA - one way (Example 10.3)

```{r}
Spower(p_anova.test, n=NA, k=10, f=.25, power=.95, interval=c(20, 300), verbose=FALSE)
```

G\*power gives the estimate $n=39$.

Fixing $n=200$ in total (hence, $n=200/k=20$) and performing a compromise analysis assuming $q=\frac{\beta}{\alpha}=1$,

```{r}
Spower(p_anova.test, n=20, k=10, f=.25, beta_alpha=1, replications=30000, verbose=FALSE)
```

G\*Power gives $\alpha=\beta=0.159$.

# Variance tests

## Variance - difference from constant (one sample case; Example 26.3)

```{r}
# solve n for variance ratio of 1/1.5 = 2/3, one.tailed, 80% power
Spower(p_var.test, n=NA, sds=sqrt(1), sigma=sqrt(1.5), 
	   two.tailed=FALSE, power=.80, interval=c(10, 200), verbose=FALSE)
```

G\*power gives sample size of 81.

## Two-sample variance test (Example 15.3)

For a two-sample equality of variance test with equal sample sizes,

```{r}
# solve n for variance ratio of 1/1.5 = 2/3, two.tailed, 80% power
Spower(p_var.test, n=NA, sds=sqrt(c(1, 1.5)), 
	   two.tailed=TRUE, power=.80, interval=c(50, 300), verbose=FALSE)
```

G\*Power gives estimate of 193 per group.

# Two-group designs (t-test)

## Independent samples t-test 

Estimate sample size ($n$) per group in independent samples $t$-test, one-tailed, medium effect size ($d=0.5$), $\alpha=0.05$, 95% power ($1-\beta = 0.95$), equal sample sizes ($\frac{n_2}{n_1}=1$).

```{r}
(out <- Spower(p_t.test, n = NA, d = .5, two.tailed=FALSE, 
			   power = .95, interval=c(10,500), verbose=FALSE))
```

```{r echo=FALSE}
so <- summary(out)
```

G\*power estimate is 88 per group, `Spower` estimate is `r out$n` with the 95% CI [`r so$predCIs_root`].

## 

Relatedly, one can specify $r$, a point-biserial correlation, instead of $d$ since $r$ is easily converted to $d$.

### Point-biserial correlation (Example 16.3)

```{r}
# solution per group
out <- Spower(p_t.test, r = .25, power = .95, n = NA,
			  two.tailed=FALSE, interval=c(50, 200), verbose=FALSE)
out

# total sample size required
ceiling(out$n) * 2
```

G\*power gives the result $N=164$.

## Paired samples t-test (Example 19.3)

### 

```{r}
Spower(p_t.test, n=50, d=0.421637, type = 'paired', verbose=FALSE)
```

G\*power gives power estimate of .832.

## One-sample t-test (Example 20.3)

```{r}
Spower(p_t.test, n=NA, d=.625, power=.95, 
	   two.tailed=FALSE, type='one.sample', interval=c(10, 100), verbose=FALSE)
```

G\*power gives sample size of $n=30$.

## 

```{r}
Spower(p_t.test, n=NA, d=.1, power=.9, 
	   type='one.sample', sig.level=.01, interval=c(100,2000), verbose=FALSE)
```

G\*power gives sample size of $n=1492$.

# Wilcox tests

## One-sample test with normal (Example 22.3)

```{r}
Spower(p_wilcox.test, n=649, d=.1, two.tailed=FALSE, verbose=FALSE)
```

G\*power provide power estimate of .800.
